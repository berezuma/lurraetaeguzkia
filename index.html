<!DOCTYPE html>
<html lang="eu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lurra-Eguzkia Simulagailua</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SunCalc.js liburutegia gehituta -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
    }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #111827;
            color: #e5e7eb;
            overflow: hidden;
        }
        #canvas-container {
            width: 100vw;
            height: 100vh;
        }
        @media (max-width: 768px) {
            body {
                overflow: auto; 
            }
            #main-container {
                flex-direction: column;
            }
            #info-panel {
                position: static;
                max-width: 100%;
                border-radius: 0;
                border: 0;
                border-bottom: 1px solid #374151;
            }
            #canvas-container {
                height: 60vh; 
            }
        }
        
        .slider-container {
            margin-bottom: 1rem;
        }
        .slider-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #374151;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #1f2739;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #1f2739;
        }
        .info-display {
            background-color: #1f2937;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
            color: #d1d5db;
        }
        .autocomplete-item {
            padding: 0.5rem;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background-color: #374151;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="main-container" class="relative flex w-full h-full">
        <!-- Kontrol panela -->
        <div id="info-panel" class="md:absolute md:top-5 md:left-5 md:max-w-sm w-full z-10 bg-gray-900/80 md:backdrop-blur-sm md:border md:border-gray-700 md:rounded-lg p-4 max-h-[95vh] overflow-y-auto">
            <h1 class="text-xl font-bold mb-4 text-white">Lurra-Eguzkia Simulagailua</h1>
            
            <div class="mb-4 relative" id="search-container">
                <label for="city-search" class="block mb-2 font-medium">Bilatu hiria</label>
                <input type="text" id="city-search" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="adib. Erandio, Tokyo..." autocomplete="off">
                <div id="autocomplete-results" class="absolute z-10 w-full bg-gray-800 border border-gray-600 rounded-md mt-1 hidden max-h-48 overflow-y-auto"></div>
                <p id="search-error" class="text-red-400 text-xs mt-1 hidden">Hiria ez da aurkitu.</p>
            </div>

            <div class="mb-4 flex justify-center space-x-2">
                <button id="pause-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Pausatu
                </button>
                <button id="play-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center w-full hidden">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Hasi
                </button>
            </div>
            
            <div class="slider-container">
                <label for="day-slider">Urteko eguna</label>
                <input type="range" id="day-slider" min="1" max="365" value="182">
                <div id="day-display" class="info-display mt-2"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="slider-container">
                    <label for="latitude-slider">Latitudea</label>
                    <input type="range" id="latitude-slider" min="-90" max="90" value="43.3" step="0.1">
                    <div id="latitude-display" class="info-display mt-2"></div>
                </div>
                <div class="slider-container">
                    <label for="longitude-slider">Longitudea</label>
                    <input type="range" id="longitude-slider" min="-180" max="180" value="-2.98" step="0.1">
                    <div id="longitude-display" class="info-display mt-2"></div>
                </div>
            </div>

            <div class="mt-2">
                <div id="season-display" class="info-display text-lg"></div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Egunsentia</p>
                        <div id="sunrise-display" class="info-display text-sm py-1">--:--</div>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Ilunabarra</p>
                        <div id="sunset-display" class="info-display text-sm py-1">--:--</div>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Iraupena</p>
                        <div id="duration-display" class="info-display text-sm py-1">--h --m</div>
                    </div>
                </div>
                <div id="polar-status-display" class="info-display mt-2 text-sm hidden bg-blue-900/50"></div>
                <p class="text-xs text-gray-500 mt-2 text-center">Oharra: Orduak hiriko ordu lokalean adierazita daude.</p>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-700 text-center text-xs text-gray-500">
                <p>Egilea: Beñat Erezuma Arisketa</p>
                <p><a href="https://berezuma.com" target="_blank" class="underline hover:text-gray-300">berezuma.com</a> • Lizentzia: MIT</p>
            </div>
        </div>

        <div id="canvas-container" class="flex-grow"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        // --- PREDEFINED CITIES WITH TIMEZONES ---
        const cities = {
            "Erandio": { lat: 43.30, lon: -2.98, tz: "Europe/Madrid" },
            "Bilbo": { lat: 43.26, lon: -2.93, tz: "Europe/Madrid" },
            "Donostia": { lat: 43.32, lon: -1.98, tz: "Europe/Madrid" },
            "Gasteiz": { lat: 42.85, lon: -2.67, tz: "Europe/Madrid" },
            "Iruñea": { lat: 42.81, lon: -1.64, tz: "Europe/Madrid" },
            "Baiona": { lat: 43.49, lon: -1.47, tz: "Europe/Paris" },
            "Tokyo": { lat: 35.68, lon: 139.69, tz: "Asia/Tokyo" },
            "New York": { lat: 40.71, lon: -74.00, tz: "America/New_York" },
            "London": { lat: 51.50, lon: -0.12, tz: "Europe/London" },
            "Sydney": { lat: -33.86, lon: 151.20, tz: "Australia/Sydney" },
            "Los Angeles": { lat: 34.05, lon: -118.24, tz: "America/Los_Angeles" },
            "Cairo": { lat: 30.04, lon: 31.23, tz: "Africa/Cairo" },
            "Rio de Janeiro": { lat: -22.90, lon: -43.17, tz: "America/Sao_Paulo" }
        };

        const canvasContainer = document.getElementById('canvas-container');

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
        camera.position.z = 6;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        canvasContainer.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 2.5;
        controls.maxDistance = 50;

        const spotLight = new THREE.SpotLight(0xffffff, 500, 100, Math.PI / 8, 0.2, 2);
        spotLight.castShadow = true;
        scene.add(spotLight);

        const spotLightTarget = new THREE.Object3D();
        spotLightTarget.position.set(0, 0, 0);
        scene.add(spotLightTarget);
        spotLight.target = spotLightTarget;

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.1);
        scene.add(ambientLight);

        const earthGroup = new THREE.Group();
        const EARTH_RADIUS = 1.5;
        const AXIAL_TILT = 23.44 * (Math.PI / 180);

        const earthGeometry = new THREE.SphereGeometry(EARTH_RADIUS, 64, 64);
        const earthMaterial = new THREE.MeshStandardMaterial({
            map: new THREE.TextureLoader().load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/land_ocean_ice_cloud_2048.jpg', 
                (texture) => { texture.colorSpace = THREE.SRGBColorSpace; },
                undefined,
                (err) => {
                    console.error('An error happened loading the texture.');
                    earthMaterial.map = null;
                    earthMaterial.color.set(0x2266dd);
                    earthMaterial.needsUpdate = true;
                }
            ),
            metalness: 0.2,
            roughness: 0.8
        });
        const earth = new THREE.Mesh(earthGeometry, earthMaterial);
        earth.castShadow = true;
        earth.receiveShadow = true;
        earth.rotation.y = -Math.PI / 2;
        earthGroup.add(earth);

        const axisMaterial = new THREE.LineBasicMaterial({ color: 0xff0000, linewidth: 2 });
        const axisPoints = [new THREE.Vector3(0, -EARTH_RADIUS * 1.5, 0), new THREE.Vector3(0, EARTH_RADIUS * 1.5, 0)];
        const axisGeometry = new THREE.BufferGeometry().setFromPoints(axisPoints);
        const axisLine = new THREE.Line(axisGeometry, axisMaterial);
        earthGroup.add(axisLine);

        const markerGeometry = new THREE.SphereGeometry(0.05, 16, 16);
        const markerMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const latitudeMarker = new THREE.Mesh(markerGeometry, markerMaterial);
        earthGroup.add(latitudeMarker);
        
        earthGroup.rotation.z = -AXIAL_TILT;
        scene.add(earthGroup);

        const daySlider = document.getElementById('day-slider');
        const latitudeSlider = document.getElementById('latitude-slider');
        const longitudeSlider = document.getElementById('longitude-slider');
        const dayDisplay = document.getElementById('day-display');
        const latitudeDisplay = document.getElementById('latitude-display');
        const longitudeDisplay = document.getElementById('longitude-display');
        const seasonDisplay = document.getElementById('season-display');
        const sunriseDisplay = document.getElementById('sunrise-display');
        const sunsetDisplay = document.getElementById('sunset-display');
        const durationDisplay = document.getElementById('duration-display');
        const polarStatusDisplay = document.getElementById('polar-status-display');
        const citySearchInput = document.getElementById('city-search');
        const searchError = document.getElementById('search-error');
        const autocompleteResults = document.getElementById('autocomplete-results');
        const searchContainer = document.getElementById('search-container');
        const playButton = document.getElementById('play-button');
        const pauseButton = document.getElementById('pause-button');
        
        let isRotating = true;
        let currentTimezone = "Europe/Madrid"; // Ordu-eremu lehenetsia

        function getDateFromDay(dayOfYear) {
            const date = new Date(new Date().getFullYear(), 0); 
            return new Date(date.setDate(dayOfYear));
        }

        function updateSimulation() {
            const dayOfYear = parseInt(daySlider.value);
            const latitude = parseFloat(latitudeSlider.value);
            const longitude = parseFloat(longitudeSlider.value);
            const date = getDateFromDay(dayOfYear);

            const sunDistance = 20;
            const sunAngle = (2 * Math.PI / 365) * (dayOfYear + 10);
            const sunDeclination = -AXIAL_TILT * Math.cos(sunAngle);
            
            spotLight.position.set(0, sunDistance * Math.sin(sunDeclination), sunDistance * Math.cos(sunDeclination));

            const latRad = latitude * (Math.PI / 180);
            const lonRad = longitude * (Math.PI / 180);
            latitudeMarker.position.set(
                EARTH_RADIUS * Math.cos(latRad) * Math.sin(lonRad),
                EARTH_RADIUS * Math.sin(latRad),
                EARTH_RADIUS * Math.cos(latRad) * Math.cos(lonRad)
            );

            const hilabeteak = ["Urtarrilak", "Otsailak", "Martxoak", "Apirilak", "Maiatzak", "Ekainak", "Uztailak", "Abuztuak", "Irailak", "Urriak", "Azaroak", "Abenduak"];
            dayDisplay.textContent = `${dayOfYear}. eguna (${hilabeteak[date.getMonth()]} ${date.getDate()})`;
            latitudeDisplay.textContent = `${Math.abs(latitude).toFixed(2)}º ${latitude >= 0 ? 'I' : 'H'}`;
            longitudeDisplay.textContent = `${Math.abs(longitude).toFixed(2)}º ${longitude >= 0 ? 'E' : 'M'}`;

            let season = '';
            if (latitude >= 0) {
                if (dayOfYear >= 80 && dayOfYear < 172) season = 'Udaberria';
                else if (dayOfYear >= 172 && dayOfYear < 264) season = 'Uda';
                else if (dayOfYear >= 264 && dayOfYear < 355) season = 'Udazkena';
                else season = 'Negua';
            } else {
                if (dayOfYear >= 80 && dayOfYear < 172) season = 'Udazkena';
                else if (dayOfYear >= 172 && dayOfYear < 264) season = 'Negua';
                else if (dayOfYear >= 264 && dayOfYear < 355) season = 'Udaberria';
                else season = 'Uda';
            }
            seasonDisplay.textContent = season;

            const times = SunCalc.getTimes(date, latitude, longitude);
            const sunrise = times.sunrise;
            const sunset = times.sunset;
            
            polarStatusDisplay.classList.add('hidden');

            if (sunrise instanceof Date && !isNaN(sunrise) && sunset instanceof Date && !isNaN(sunset)) {
                const formatTime = (date) => {
                    return date.toLocaleTimeString('eu-ES', {
                        timeZone: currentTimezone,
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                sunriseDisplay.textContent = formatTime(sunrise);
                sunsetDisplay.textContent = formatTime(sunset);

                const durationMs = sunset.getTime() - sunrise.getTime();
                const durationHours = Math.floor(durationMs / 3600000);
                const durationMinutes = Math.floor((durationMs % 3600000) / 60000);
                durationDisplay.textContent = `${durationHours}h ${durationMinutes}m`;

            } else {
                sunriseDisplay.textContent = "--:--";
                sunsetDisplay.textContent = "--:--";
                const sunPos = SunCalc.getPosition(date, latitude, longitude);
                if (sunPos.altitude > 0) {
                    durationDisplay.textContent = "24h 0m";
                    polarStatusDisplay.textContent = "24 orduko eguna (gauerdiko eguzkia)";
                } else {
                    durationDisplay.textContent = "0h 0m";
                    polarStatusDisplay.textContent = "24 orduko gaua (gau polarra)";
                }
                polarStatusDisplay.classList.remove('hidden');
            }
        }

        let autocompleteTimeout;
        citySearchInput.addEventListener('input', () => {
            clearTimeout(autocompleteTimeout);
            const query = citySearchInput.value.toLowerCase();
            
            if (query.length < 2) {
                autocompleteResults.classList.add('hidden');
                return;
            }
            
            const filteredCities = Object.keys(cities).filter(cityName => 
                cityName.toLowerCase().includes(query)
            );

            autocompleteResults.innerHTML = '';
            if (filteredCities.length > 0) {
                filteredCities.forEach(cityName => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = cityName;
                    item.addEventListener('click', () => {
                        const cityData = cities[cityName];
                        citySearchInput.value = cityName;
                        latitudeSlider.value = cityData.lat;
                        longitudeSlider.value = cityData.lon;
                        currentTimezone = cityData.tz; // Ezarri ordu-eremu zuzena
                        updateSimulation();
                        autocompleteResults.classList.add('hidden');
                    });
                    autocompleteResults.appendChild(item);
                });
                autocompleteResults.classList.remove('hidden');
            } else {
                autocompleteResults.classList.add('hidden');
            }
        });

        document.addEventListener('click', (event) => {
            if (!searchContainer.contains(event.target)) {
                autocompleteResults.classList.add('hidden');
            }
        });

        daySlider.addEventListener('input', updateSimulation);
        latitudeSlider.addEventListener('input', updateSimulation);
        longitudeSlider.addEventListener('input', updateSimulation);
        
        pauseButton.addEventListener('click', () => {
            isRotating = false;
            pauseButton.classList.add('hidden');
            playButton.classList.remove('hidden');
        });

        playButton.addEventListener('click', () => {
            isRotating = true;
            playButton.classList.add('hidden');
            pauseButton.classList.remove('hidden');
        });

        function animate() {
            requestAnimationFrame(animate);
            if (isRotating) {
                earthGroup.rotation.y += 0.002;
            }
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        }
        window.addEventListener('resize', onWindowResize);
        
        onWindowResize();
        updateSimulation();
        animate();
    </script>
</body>
</html>