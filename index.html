<!DOCTYPE html>
<html lang="eu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lurra-Eguzkia Simulagailua (Orbita bertsioa)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SunCalc.js liburutegia gehituta -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
    }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #000000; /* Hondoa beltzagoa, espazioa irudikatzeko */
            color: #e5e7eb;
            overflow: hidden;
        }
        #canvas-container {
            width: 100vw;
            height: 100vh;
            cursor: grab;
        }
        #canvas-container:active {
            cursor: grabbing;
        }
        
        /* Panelaren scroll-a kudeatzeko estiloa */
        #info-panel {
            max-height: calc(100vh - 40px); /* goiko eta beheko marjinak kontuan hartu */
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            body {
                overflow: auto; /* Scroll orokorra ahalbidetu mugikorrean */
            }
            #main-container {
                flex-direction: column;
            }
            #info-panel {
                position: static;
                max-width: 100%;
                border-radius: 0;
                border: 0;
                border-bottom: 1px solid #374151;
                max-height: none; /* Estiloa berrezarri mugikorrerako */
                overflow-y: visible; /* Estiloa berrezarri mugikorrerako */
            }
            #canvas-container {
                height: 60vh; /* Simulazioari altuera eman mugikorrean */
            }
        }
        
        .slider-container {
            margin-bottom: 0.75rem;
        }
        .slider-container label {
            display: block;
            margin-bottom: 0.25rem; /* Tartea txikitu */
            font-weight: 500;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #374151;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px; /* Tamaina txikitu */
            height: 18px; /* Tamaina txikitu */
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #1f2739;
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #1f2739;
        }
        .info-display {
            background-color: #1f2937;
            padding: 0.35rem 0.6rem; /* Padding txikitu */
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
            color: #d1d5db;
        }
        .autocomplete-item {
            padding: 0.5rem;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background-color: #374151;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="main-container" class="relative flex w-full h-full">
        <!-- Kontrol panela -->
        <div id="info-panel" class="md:absolute md:top-5 md:left-5 md:max-w-sm w-full z-10 bg-gray-900/80 md:backdrop-blur-sm md:border md:border-gray-700 md:rounded-lg p-4">
            <h1 class="text-lg font-bold mb-3 text-white">Lurra-Eguzkia Simulagailua</h1>
            
            <div class="mb-3 relative" id="search-container">
                <label for="city-search" class="block text-sm mb-1 font-medium">Bilatu hiria</label>
                <div class="flex">
                    <input type="text" id="city-search" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-l-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2" placeholder="adib. Ajangiz" autocomplete="off">
                    <button id="search-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 text-sm rounded-r-md">Bilatu</button>
                </div>
                <div id="autocomplete-results" class="absolute z-10 w-full bg-gray-800 border border-gray-600 rounded-md mt-1 hidden max-h-48 overflow-y-auto"></div>
                <p id="search-error" class="text-red-400 text-xs mt-1 hidden">Hiria ez da aurkitu.</p>
            </div>

            <div class="mb-3 flex justify-center space-x-2">
                <button id="pause-button" class="text-sm bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-md flex items-center justify-center w-full">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Pausatu
                </button>
                <button id="play-button" class="text-sm bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-md flex items-center justify-center w-full hidden">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Hasi
                </button>
            </div>

            <div class="mb-3">
                <button id="toggle-view-button" class="text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md w-full">
                    Lurraren ikuspegia
                </button>
            </div>
            
            <div class="slider-container">
                <label for="day-slider" class="text-sm">Urteko eguna</label>
                <input type="range" id="day-slider" min="1" max="365" value="169">
                <div id="day-display" class="info-display text-sm mt-1"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="slider-container">
                    <label for="latitude-slider" class="text-sm">Latitudea</label>
                    <input type="range" id="latitude-slider" min="-90" max="90" value="43.3" step="0.1">
                    <div id="latitude-display" class="info-display text-sm mt-1"></div>
                </div>
                <div class="slider-container">
                    <label for="longitude-slider" class="text-sm">Longitudea</label>
                    <input type="range" id="longitude-slider" min="-180" max="180" value="-2.68" step="0.1">
                    <div id="longitude-display" class="info-display text-sm mt-1"></div>
                </div>
            </div>

            <div class="mt-2">
                <div id="season-display" class="info-display text-base"></div>
            </div>

            <div class="mt-3 pt-3 border-t border-gray-700">
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Egunsentia</p>
                        <div id="sunrise-display" class="info-display text-xs py-1">--:--</div>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Ilunabarra</p>
                        <div id="sunset-display" class="info-display text-xs py-1">--:--</div>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Iraupena</p>
                        <div id="duration-display" class="info-display text-xs py-1">--h --m</div>
                    </div>
                </div>
                <div id="polar-status-display" class="info-display mt-2 text-xs hidden bg-blue-900/50"></div>
                <p class="text-xs text-gray-500 mt-2 text-center">Oharra: Orduak hautatutako hiriko ordu ofizialari dagozkio (udako ordutegia barne).</p>
                
                <!-- Konparaketa atala -->
                <div class="mt-3">
                    <button id="compare-button" class="text-sm bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md w-full">
                        Konparatu datak
                    </button>
                    <p id="compare-instruction" class="text-xs text-center text-teal-300 mt-2 hidden">Orain, mugitu 'Urteko eguna' graduatzailea bigarren data bat aukeratzeko.</p>
                </div>
            </div>

            <!-- Konparaketa panela -->
            <div id="comparison-panel" class="mt-3 pt-3 border-t border-gray-700 hidden">
                <h2 class="text-base font-semibold mb-2 text-white">Konparaketa</h2>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <!-- 1. Puntua -->
                    <div>
                        <p id="compare-date-1" class="text-xs font-bold text-gray-300 mb-1">--</p>
                        <div id="compare-duration-1" class="info-display text-xs py-1 bg-gray-800">--h --m</div>
                    </div>
                    <!-- 2. Puntua -->
                    <div>
                        <p id="compare-date-2" class="text-xs font-bold text-gray-300 mb-1">--</p>
                        <div id="compare-duration-2" class="info-display text-xs py-1">--h --m</div>
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <p class="text-xs text-gray-400 mb-1">Aldea</p>
                    <div id="compare-diff" class="info-display text-sm py-1 font-bold bg-gray-700">--h --m</div>
                </div>
            </div>

            <!-- Egilearen informazioa -->
            <div class="mt-3 pt-3 border-t border-gray-700 text-center text-xs text-gray-500">
                <p>Egilea: Beñat Erezuma Arisketa</p>
                <p><a href="https://berezuma.com" target="_blank" class="underline hover:text-gray-300">berezuma.com</a> • Lizentzia: MIT</p>
            </div>
        </div>

        <!-- 3D Simulazioaren edukiontzia -->
        <div id="canvas-container" class="flex-grow"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        const canvasContainer = document.getElementById('canvas-container');

        // --- OINARRIZKO KONFIGURAZIOA ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
        camera.position.set(0, 15, 30);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        canvasContainer.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 5;
        controls.maxDistance = 100;
        controls.target.set(0, 0, 0);

        // --- EGUZKIA, ARGIA ETA ORBITA ---
        const ORBIT_RADIUS_X = 20;
        const ORBIT_RADIUS_Z = 20;

        const sunGeometry = new THREE.SphereGeometry(2, 32, 32);
        const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xffdd88 });
        const sun = new THREE.Mesh(sunGeometry, sunMaterial);
        scene.add(sun);

        const spotLight = new THREE.SpotLight(0xffffff, 4000, 500, Math.PI / 4, 0.2, 2);
        spotLight.castShadow = true;
        spotLight.position.set(0, 0, 0);
        scene.add(spotLight);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.05);
        scene.add(ambientLight);
        
        const orbitCurve = new THREE.EllipseCurve(0, 0, ORBIT_RADIUS_X, ORBIT_RADIUS_Z, 0, 2 * Math.PI, false, 0);
        const orbitPoints = orbitCurve.getPoints(200);
        const orbitGeometry = new THREE.BufferGeometry().setFromPoints(orbitPoints);
        const orbitMaterial = new THREE.LineBasicMaterial({ color: 0x444444 });
        const orbitLine = new THREE.Line(orbitGeometry, orbitMaterial);
        orbitLine.rotation.x = Math.PI / 2;
        scene.add(orbitLine);


        // --- LURRAREN OBJEKTUAK ---
        const earthGroup = new THREE.Group();
        const earthSphereGroup = new THREE.Group();
        const EARTH_RADIUS = 1.5;
        const AXIAL_TILT = 23.44 * (Math.PI / 180);

        const earthGeometry = new THREE.SphereGeometry(EARTH_RADIUS, 64, 64);
        const earthMaterial = new THREE.MeshStandardMaterial({
            map: new THREE.TextureLoader().load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/land_ocean_ice_cloud_2048.jpg', 
                (texture) => { texture.colorSpace = THREE.SRGBColorSpace; },
                undefined,
                (err) => {
                    console.error('An error happened loading the texture.');
                    earthMaterial.map = null;
                    earthMaterial.color.set(0x2266dd);
                    earthMaterial.needsUpdate = true;
                }
            ),
            metalness: 0.2,
            roughness: 0.8
        });
        const earth = new THREE.Mesh(earthGeometry, earthMaterial);
        earth.castShadow = true;
        earth.receiveShadow = true;
        earth.rotation.y = -Math.PI / 2;
        earthSphereGroup.add(earth);

        spotLight.target = earthGroup;

        const axisMaterial = new THREE.LineBasicMaterial({ color: 0xff0000, linewidth: 2 });
        const axisPoints = [new THREE.Vector3(0, -EARTH_RADIUS * 1.5, 0), new THREE.Vector3(0, EARTH_RADIUS * 1.5, 0)];
        const axisGeometry = new THREE.BufferGeometry().setFromPoints(axisPoints);
        const axisLine = new THREE.Line(axisGeometry, axisMaterial);
        earthSphereGroup.add(axisLine);

        function createCircleLine(radius, color) {
            const points = [];
            for (let i = 0; i <= 128; i++) {
                const theta = (i / 128) * Math.PI * 2;
                points.push(new THREE.Vector3(Math.cos(theta) * radius, 0, Math.sin(theta) * radius));
            }
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ color: color });
            return new THREE.Line(geometry, material);
        }

        const equator = createCircleLine(EARTH_RADIUS, 0xffff00);
        earthSphereGroup.add(equator);
        const tropicOfCancer = createCircleLine(EARTH_RADIUS * Math.cos(AXIAL_TILT), 0xffa500);
        tropicOfCancer.position.y = EARTH_RADIUS * Math.sin(AXIAL_TILT);
        earthSphereGroup.add(tropicOfCancer);
        const tropicOfCapricorn = createCircleLine(EARTH_RADIUS * Math.cos(AXIAL_TILT), 0xffa500);
        tropicOfCapricorn.position.y = -EARTH_RADIUS * Math.sin(AXIAL_TILT);
        earthSphereGroup.add(tropicOfCapricorn);

        const markerGeometry = new THREE.SphereGeometry(0.05, 16, 16);
        const markerMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const latitudeMarker = new THREE.Mesh(markerGeometry, markerMaterial);
        earthSphereGroup.add(latitudeMarker);
        
        earthGroup.add(earthSphereGroup);
        earthGroup.rotation.z = -AXIAL_TILT;
        scene.add(earthGroup);

        // --- KONTROLEN LOGIKA ---
        const daySlider = document.getElementById('day-slider');
        const latitudeSlider = document.getElementById('latitude-slider');
        const longitudeSlider = document.getElementById('longitude-slider');
        const dayDisplay = document.getElementById('day-display');
        const latitudeDisplay = document.getElementById('latitude-display');
        const longitudeDisplay = document.getElementById('longitude-display');
        const seasonDisplay = document.getElementById('season-display');
        const sunriseDisplay = document.getElementById('sunrise-display');
        const sunsetDisplay = document.getElementById('sunset-display');
        const durationDisplay = document.getElementById('duration-display');
        const polarStatusDisplay = document.getElementById('polar-status-display');
        const citySearchInput = document.getElementById('city-search');
        const searchButton = document.getElementById('search-button');
        const searchError = document.getElementById('search-error');
        const autocompleteResults = document.getElementById('autocomplete-results');
        const searchContainer = document.getElementById('search-container');
        const playButton = document.getElementById('play-button');
        const pauseButton = document.getElementById('pause-button');
        const toggleViewButton = document.getElementById('toggle-view-button');
        const compareButton = document.getElementById('compare-button');
        const compareInstruction = document.getElementById('compare-instruction');
        const comparisonPanel = document.getElementById('comparison-panel');
        const compareDate1 = document.getElementById('compare-date-1');
        const compareDuration1 = document.getElementById('compare-duration-1');
        const compareDate2 = document.getElementById('compare-date-2');
        const compareDuration2 = document.getElementById('compare-duration-2');
        const compareDiff = document.getElementById('compare-diff');
        
        let currentTimeZone = 'Europe/Madrid';
        let lastLatLon = '';
        let isRotating = true;
        let isGlobalView = true;
        let isComparing = false;
        let comparisonPoint1 = null;

        function getDateFromDay(dayOfYear) {
            const date = new Date(new Date().getFullYear(), 0); 
            return new Date(date.setDate(dayOfYear));
        }
        
        function updateInstantVisuals() {
            const dayOfYear = parseInt(daySlider.value);
            const latitude = parseFloat(latitudeSlider.value);
            const longitude = parseFloat(longitudeSlider.value);
            const date = getDateFromDay(dayOfYear);

            const orbitalAngle = ((dayOfYear - 355) / 365) * 2 * Math.PI;
            const earthX = Math.cos(orbitalAngle) * ORBIT_RADIUS_X;
            const earthZ = Math.sin(orbitalAngle) * ORBIT_RADIUS_Z;
            earthGroup.position.set(earthX, 0, earthZ);
            
            const latRad = latitude * (Math.PI / 180);
            const lonRad = longitude * (Math.PI / 180);
            latitudeMarker.position.set(
                EARTH_RADIUS * Math.cos(latRad) * Math.sin(lonRad),
                EARTH_RADIUS * Math.sin(latRad),
                EARTH_RADIUS * Math.cos(latRad) * Math.cos(lonRad)
            );

            const hilabeteak = ["Urtarrilak", "Otsailak", "Martxoak", "Apirilak", "Maiatzak", "Ekainak", "Uztailak", "Abuztuak", "Irailak", "Urriak", "Azaroak", "Abenduak"];
            const monthName = hilabeteak[date.getMonth()];
            const dayNumber = date.getDate();
            dayDisplay.textContent = `${dayOfYear}. eguna (${monthName} ${dayNumber})`;
            latitudeDisplay.textContent = `${Math.abs(latitude).toFixed(2)}º ${latitude >= 0 ? 'I' : 'H'}`;
            longitudeDisplay.textContent = `${Math.abs(longitude).toFixed(2)}º ${longitude >= 0 ? 'E' : 'M'}`;

            let season = '';
            if (latitude >= 0) {
                if (dayOfYear >= 80 && dayOfYear < 172) season = 'Udaberria';
                else if (dayOfYear >= 172 && dayOfYear < 264) season = 'Uda';
                else if (dayOfYear >= 264 && dayOfYear < 355) season = 'Udazkena';
                else season = 'Negua';
            } else {
                if (dayOfYear >= 80 && dayOfYear < 172) season = 'Udazkena';
                else if (dayOfYear >= 172 && dayOfYear < 264) season = 'Negua';
                else if (dayOfYear >= 264 && dayOfYear < 355) season = 'Udaberria';
                else season = 'Uda';
            }
            seasonDisplay.textContent = season;
        }

        async function updateAsyncData() {
            const dayOfYear = parseInt(daySlider.value);
            const latitude = parseFloat(latitudeSlider.value);
            const longitude = parseFloat(longitudeSlider.value);
            const date = getDateFromDay(dayOfYear);

            const currentLatLon = `${latitude.toFixed(2)},${longitude.toFixed(2)}`;
            if (lastLatLon !== currentLatLon) {
                try {
                    const tzResponse = await fetch(`https://timeapi.io/api/TimeZone/coordinate?latitude=${latitude}&longitude=${longitude}`);
                    const tzData = await tzResponse.json();
                    currentTimeZone = tzData.timeZone;
                    lastLatLon = currentLatLon;
                } catch (e) {
                    console.error("Ezin izan da ordu-eremua lortu:", e);
                    currentTimeZone = null;
                }
            }
            
            const times = SunCalc.getTimes(date, latitude, longitude);
            const sunrise = times.sunrise;
            const sunset = times.sunset;
            
            polarStatusDisplay.classList.add('hidden');

            if (sunrise instanceof Date && !isNaN(sunrise) && sunset instanceof Date && !isNaN(sunset)) {
                if (currentTimeZone) {
                    const options = { timeZone: currentTimeZone, hour: '2-digit', minute: '2-digit', hour12: false };
                    sunriseDisplay.textContent = sunrise.toLocaleTimeString('eu-ES', options);
                    sunsetDisplay.textContent = sunset.toLocaleTimeString('eu-ES', options);
                } else {
                    sunriseDisplay.textContent = "Errorea";
                    sunsetDisplay.textContent = "Errorea";
                }

                const durationMs = sunset.getTime() - sunrise.getTime();
                const durationHours = Math.floor(durationMs / 3600000);
                const durationMinutes = Math.floor((durationMs % 3600000) / 60000);
                durationDisplay.textContent = `${durationHours}h ${durationMinutes}m`;

            } else {
                sunriseDisplay.textContent = "--:--";
                sunsetDisplay.textContent = "--:--";
                const sunPos = SunCalc.getPosition(date, latitude, longitude);
                if (sunPos.altitude > 0) {
                    durationDisplay.textContent = "24h 0m";
                    polarStatusDisplay.textContent = "24 orduko eguna (gauerdiko eguzkia)";
                    polarStatusDisplay.classList.remove('hidden');
                } else {
                    durationDisplay.textContent = "0h 0m";
                    polarStatusDisplay.textContent = "24 orduko gaua (gau polarra)";
                    polarStatusDisplay.classList.remove('hidden');
                }
            }
        }

        function parseDurationToMs(durationText) {
            if (!durationText || durationText.includes('--') || durationText.includes('Kalkulatzen')) {
                return null;
            }
            const parts = durationText.replace('h', '').replace('m', '').split(' ');
            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            return (hours * 3600 + minutes * 60) * 1000;
        }

        function updateComparisonPanel() {
            if (!isComparing || !comparisonPoint1) return;

            const dayOfYear2 = parseInt(daySlider.value);
            const date2 = getDateFromDay(dayOfYear2);
            const hilabeteak = ["Urt", "Ots", "Mar", "Api", "Mai", "Eka", "Uzt", "Abu", "Ira", "Urr", "Aza", "Abe"];
            const monthName2 = hilabeteak[date2.getMonth()];
            const dayNumber2 = date2.getDate();
            
            const durationText2 = durationDisplay.textContent;
            const durationMs2 = parseDurationToMs(durationText2);

            compareDate2.textContent = `${monthName2} ${dayNumber2}`;
            compareDuration2.textContent = durationText2;
            
            if (comparisonPoint1.durationMs !== null && durationMs2 !== null) {
                const diffMs = durationMs2 - comparisonPoint1.durationMs;
                const sign = diffMs >= 0 ? '+' : '-';
                const absDiffMs = Math.abs(diffMs);
                
                const diffHours = Math.floor(absDiffMs / 3600000);
                const diffMinutes = Math.floor((absDiffMs % 3600000) / 60000);
                
                compareDiff.textContent = `${sign} ${diffHours}h ${diffMinutes}m`;
                
                compareDiff.classList.remove('bg-green-800', 'bg-red-800', 'bg-gray-700');
                if (diffMs > 0) {
                    compareDiff.classList.add('bg-green-800');
                } else if (diffMs < 0) {
                    compareDiff.classList.add('bg-red-800');
                } else {
                    compareDiff.classList.add('bg-gray-700');
                }
            } else {
                compareDiff.textContent = '--h --m';
            }
        }

        async function updateSimulation() {
            updateInstantVisuals();
            
            const calculatingText = 'Kalkulatzen...';
            sunriseDisplay.textContent = calculatingText;
            sunsetDisplay.textContent = calculatingText;
            durationDisplay.textContent = calculatingText;

            await updateAsyncData();
            updateComparisonPanel();
        }

        async function searchCity(cityName) {
            if (!cityName) return;
            searchButton.textContent = 'Bilatzen...';
            searchButton.disabled = true;
            searchError.classList.add('hidden');
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityName)}&format=json&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    const city = data[0];
                    latitudeSlider.value = parseFloat(city.lat);
                    longitudeSlider.value = parseFloat(city.lon);
                    await updateSimulation();
                } else {
                    searchError.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Errorea hiria bilatzean:", error);
                searchError.textContent = "Errore bat gertatu da bilatzean.";
                searchError.classList.remove('hidden');
            } finally {
                searchButton.textContent = 'Bilatu';
                searchButton.disabled = false;
            }
        }

        const iparraldeTowns = {
            'Lapurdi': ['Ahetze', 'Ahurti', 'Ainhoa', 'Angelu', 'Arbona', 'Arrangoitze', 'Azkaine', 'Baiona', 'Bardoze', 'Basusarri', 'Beskoitze', 'Biarritz', 'Bidarte', 'Biriatu', 'Bokale', 'Donibane Lohizune', 'Ezpeleta', 'Getaria', 'Gixune', 'Haltsu', 'Hazparne', 'Hendaia', 'Hiriburu', 'Itsasu', 'Jatsu', 'Kanbo', 'Larresoro', 'Lehuntze', 'Lekorne', 'Lekuine', 'Luhuso', 'Makea', 'Milafranga', 'Mugerre', 'Sara', 'Senpere', 'Urketa', 'Urruña', 'Uztaritze', 'Ziburu', 'Zuraide'],
            'Nafarroa Beherea': ['Ahatsa-Altzieta-Bazkazane', 'Aiherra', 'Ainhize-Monjolose', 'Aintzila', 'Aiziritze-Gamue-Zohazti', 'Akamarre', 'Aldude', 'Amenduze-Unaso', 'Amorotze-Zokotze', 'Anhauze', 'Arberatze-Zilhekoa', 'Arboti-Zohota', 'Arhantsusi', 'Armendaritze', 'Arnegi', 'Arrosa', 'Arrueta-Sarrikota', 'Azkarate', 'Baigorri', 'Banka', 'Bastida', 'Behaskane-Laphizketa', 'Behauze', 'Behorlegi', 'Bidarrai', 'Bidaxune', 'Bithirina', 'Bunuze', 'Burgue-Erreiti', 'Buztintze-Hiriberri', 'Donaixti-Ibarre', 'Donamartiri', 'Donapaleu', 'Donazaharre', 'Donibane Garazi', 'Donoztiri', 'Duzunaritze-Sarasketa', 'Eiheralarre', 'Erango', 'Ezterenzubi', 'Gabadi', 'Gamarte', 'Garrüze', 'Heleta', 'Hozta', 'Ibarla', 'Iholdi', 'Ilharre', 'Irisarri', 'Irulegi', 'Izpura', 'Izturitze', 'Izura-Azme', 'Jatsu Garazi', 'Jutsi', 'Labetze-Bizkai', 'Lakarra', 'Landibarre', 'Larribarre-Sorhapürü', 'Larzabale-Arroze-Zibitze', 'Lasa', 'Lekunberri', 'Lüküze-Altzümarta', 'Martxueta', 'Mehaine', 'Mendibe', 'Oragarre', 'Ortzaize', 'Ostankoa', 'Pagola', 'Suhuskune', 'Uharte Garazi', 'Uhartehiri', 'Urepele', 'Zaro'],
            'Zuberoa': ['Ainharbe', 'Aloze-Ziboze-Onizegaine', 'Altzai-Altzabeheti-Zunharreta', 'Altzürükü', 'Arrokiaga', 'Arüe-Ithorrotze-Olhaibi', 'Atharratze-Sorholüze', 'Barkoxe', 'Berrogaine-Lahüntze', 'Bildoze-Onizepea', 'Domintxaine-Berroeta', 'Eskiula', 'Etxarri', 'Etxebarre', 'Espeize-Undüreine', 'Gamere-Zihiga', 'Garindaine', 'Gotaine-Irabarne', 'Hauze', 'Idauze-Mendi', 'Iruri', 'Jestaze', 'Lakarri-Arhane-Sarrikotagaine', 'Larraine', 'Lexantzü-Zünharre', 'Ligi-Atherei', 'Liginaga-Astüe', 'Lohitzüne-Oihergi', 'Maule-Lextarre', 'Mendikota', 'Mitikile-Larrori-Mendibile', 'Montori', 'Muskildi', 'Ospitalepea', 'Ozaraine-Erribareita', 'Ozaze-Zühara', 'Santa-Grazi', 'Sarrikotapea', 'Sohüta', 'Urdiñarbe', 'Urrüstoi-Larrabile', 'Zalgize-Doneztebe']
        };
        const hegoaldeProvinces = {
            'Bizkaia': ['Bizkaia', 'Biscay'],
            'Gipuzkoa': ['Gipuzkoa', 'Guipúzcoa'],
            'Araba': ['Araba', 'Álava'],
            'Nafarroa': ['Nafarroa', 'Navarra', 'Comunidad Foral de Navarra']
        };
        const generalBasqueKeywords = ['Euskadi', 'País Vasco', 'Basque Country'];
        
        function formatBasqueDisplayName(place) {
            const displayName = place.display_name;
            const townName = displayName.split(',')[0].trim();
            let province = null;
            for (const [p, names] of Object.entries(hegoaldeProvinces)) {
                if (names.some(name => displayName.includes(name))) {
                    province = p;
                    break;
                }
            }
            if (!province && generalBasqueKeywords.some(keyword => displayName.includes(keyword))) {
                 province = displayName.split(',')[1]?.trim() || '';
            }
            if (province) {
                return `${townName}, ${province}, Euskal Herria`;
            }
            if (displayName.includes('Pyrénées-Atlantiques') || displayName.includes('Pirinio Atlantikoak')) {
                for (const [p, towns] of Object.entries(iparraldeTowns)) {
                    if (towns.map(t => t.toLowerCase()).includes(townName.toLowerCase())) {
                        province = p;
                        return `${townName}, ${province}, Euskal Herria`;
                    }
                }
            }
            return displayName;
        }

        let autocompleteTimeout;
        citySearchInput.addEventListener('input', () => {
            clearTimeout(autocompleteTimeout);
            const query = citySearchInput.value;
            if (query.length < 3) {
                autocompleteResults.classList.add('hidden');
                return;
            }
            autocompleteTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&addressdetails=1&accept-language=eu,en`);
                    const data = await response.json();
                    autocompleteResults.innerHTML = '';
                    if (data && data.length > 0) {
                        data.forEach(place => {
                            const item = document.createElement('div');
                            item.className = 'autocomplete-item';
                            item.textContent = formatBasqueDisplayName(place);
                            item.addEventListener('mousedown', (event) => {
                                event.preventDefault();
                                citySearchInput.value = place.display_name.split(',')[0];
                                latitudeSlider.value = parseFloat(place.lat);
                                longitudeSlider.value = parseFloat(place.lon);
                                updateSimulation();
                                autocompleteResults.classList.add('hidden');
                            });
                            autocompleteResults.appendChild(item);
                        });
                        autocompleteResults.classList.remove('hidden');
                    } else {
                        autocompleteResults.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Autocomplete errorea:", error);
                    autocompleteResults.classList.add('hidden');
                }
            }, 300);
        });

        document.addEventListener('click', (event) => {
            if (!searchContainer.contains(event.target)) {
                autocompleteResults.classList.add('hidden');
            }
        });

        searchButton.addEventListener('click', () => searchCity(citySearchInput.value));
        citySearchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                autocompleteResults.classList.add('hidden');
                searchCity(citySearchInput.value);
            }
        });

        daySlider.addEventListener('input', updateSimulation);
        latitudeSlider.addEventListener('input', updateSimulation);
        longitudeSlider.addEventListener('input', updateSimulation);
        
        pauseButton.addEventListener('click', () => {
            isRotating = false;
            pauseButton.classList.add('hidden');
            playButton.classList.remove('hidden');
        });

        playButton.addEventListener('click', () => {
            isRotating = true;
            playButton.classList.add('hidden');
            pauseButton.classList.remove('hidden');
        });

        function setCameraView(toGlobal) {
            isGlobalView = toGlobal;
            if (isGlobalView) {
                controls.target.set(0, 0, 0);
                controls.minDistance = 5;
                controls.maxDistance = 100;
                camera.position.set(0, 15, 30);
                toggleViewButton.textContent = 'Lurraren ikuspegia';
            } else {
                controls.target.copy(earthGroup.position);
                controls.minDistance = 2;
                controls.maxDistance = 20;
                const offset = new THREE.Vector3(0, 2, 5);
                camera.position.copy(earthGroup.position).add(offset);
                toggleViewButton.textContent = 'Ikuspegi globala';
            }
        }

        toggleViewButton.addEventListener('click', () => {
            setCameraView(!isGlobalView);
        });

        compareButton.addEventListener('click', () => {
            isComparing = !isComparing;
            if (isComparing) {
                const currentDurationMs = parseDurationToMs(durationDisplay.textContent);
                if (currentDurationMs === null) {
                    isComparing = false;
                    const originalText = compareButton.textContent;
                    compareButton.textContent = "Itxaron...";
                    compareButton.disabled = true;
                    setTimeout(() => {
                        compareButton.textContent = originalText;
                        compareButton.disabled = false;
                    }, 1500);
                    return;
                }
                
                comparisonPanel.classList.remove('hidden');
                compareInstruction.classList.remove('hidden');
                compareButton.textContent = 'Amaitu konparaketa';
                compareButton.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                compareButton.classList.add('bg-red-600', 'hover:bg-red-700');
                
                const dayOfYear = parseInt(daySlider.value);
                const date = getDateFromDay(dayOfYear);
                const hilabeteak = ["Urt", "Ots", "Mar", "Api", "Mai", "Eka", "Uzt", "Abu", "Ira", "Urr", "Aza", "Abe"];
                const monthName = hilabeteak[date.getMonth()];
                const dayNumber = date.getDate();
                
                comparisonPoint1 = {
                    dateLabel: `${monthName} ${dayNumber}`,
                    durationText: durationDisplay.textContent,
                    durationMs: currentDurationMs
                };

                compareDate1.textContent = comparisonPoint1.dateLabel;
                compareDuration1.textContent = comparisonPoint1.durationText;
                
                updateComparisonPanel();

            } else {
                comparisonPanel.classList.add('hidden');
                compareInstruction.classList.add('hidden');
                compareButton.textContent = 'Konparatu datak';
                compareButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                compareButton.classList.add('bg-teal-600', 'hover:bg-teal-700');
                comparisonPoint1 = null;
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            if (isRotating) {
                earthSphereGroup.rotation.y += 0.002;
            }
            if (!isGlobalView) {
                controls.target.copy(earthGroup.position);
            }
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        }
        window.addEventListener('resize', onWindowResize);
        
        onWindowResize();
        updateSimulation();
        animate();
    </script>
</body>
</html>
