<!DOCTYPE html>
<html lang="eu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lurra-Eguzkia Simulagailua</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SunCalc.js liburutegia gehituta -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
    }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #111827;
            color: #e5e7eb;
            overflow: hidden;
        }
        /* Pantaila txikietan, canvas-ak altuera finkoa izango du */
        #canvas-container {
            width: 100vw;
            height: 100vh;
        }
        @media (max-width: 768px) {
            body {
                overflow: auto; /* Scroll ahalbidetu mugikorrean */
            }
            #main-container {
                flex-direction: column;
            }
            #info-panel {
                position: static;
                max-width: 100%;
                border-radius: 0;
                border: 0;
                border-bottom: 1px solid #374151;
            }
            #canvas-container {
                height: 60vh; /* Simulazioari altuera eman mugikorrean */
            }
        }
        
        .slider-container {
            margin-bottom: 1rem;
        }
        .slider-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #374151;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #1f2739;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #1f2739;
        }
        .info-display {
            background-color: #1f2937;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
            color: #d1d5db;
        }
        .autocomplete-item {
            padding: 0.5rem;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background-color: #374151;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="main-container" class="relative flex w-full h-full">
        <!-- Kontrol panela -->
        <div id="info-panel" class="md:absolute md:top-5 md:left-5 md:max-w-sm w-full z-10 bg-gray-900/80 md:backdrop-blur-sm md:border md:border-gray-700 md:rounded-lg p-4">
            <h1 class="text-xl font-bold mb-4 text-white">Lurra-Eguzkia Simulagailua</h1>
            
            <div class="mb-4 relative" id="search-container">
                <label for="city-search" class="block mb-2 font-medium">Bilatu hiria</label>
                <div class="flex">
                    <input type="text" id="city-search" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-l-md focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="adib. Ajangiz" autocomplete="off">
                    <button id="search-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r-md">Bilatu</button>
                </div>
                <div id="autocomplete-results" class="absolute z-10 w-full bg-gray-800 border border-gray-600 rounded-md mt-1 hidden max-h-48 overflow-y-auto"></div>
                <p id="search-error" class="text-red-400 text-xs mt-1 hidden">Hiria ez da aurkitu.</p>
            </div>

            <div class="mb-4 flex justify-center space-x-2">
                <button id="pause-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center w-full">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Pausatu
                </button>
                <button id="play-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center w-full hidden">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Hasi
                </button>
            </div>
            
            <div class="slider-container">
                <label for="day-slider">Urteko eguna</label>
                <input type="range" id="day-slider" min="1" max="365" value="169">
                <div id="day-display" class="info-display mt-2"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="slider-container">
                    <label for="latitude-slider">Latitudea</label>
                    <input type="range" id="latitude-slider" min="-90" max="90" value="43.3" step="0.1">
                    <div id="latitude-display" class="info-display mt-2"></div>
                </div>
                <div class="slider-container">
                    <label for="longitude-slider">Longitudea</label>
                    <input type="range" id="longitude-slider" min="-180" max="180" value="-2.68" step="0.1">
                    <div id="longitude-display" class="info-display mt-2"></div>
                </div>
            </div>

            <div class="mt-2">
                <div id="season-display" class="info-display text-lg"></div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Egunsentia</p>
                        <div id="sunrise-display" class="info-display text-sm py-1">--:--</div>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Ilunabarra</p>
                        <div id="sunset-display" class="info-display text-sm py-1">--:--</div>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 mb-1">Iraupena</p>
                        <div id="duration-display" class="info-display text-sm py-1">--h --m</div>
                    </div>
                </div>
                <div id="polar-status-display" class="info-display mt-2 text-sm hidden bg-blue-900/50"></div>
                <p class="text-xs text-gray-500 mt-2 text-center">Oharra: Orduak tokiko eguzki-orduan daude, udako ordutegia kontuan hartu gabe.</p>
            </div>

            <!-- Egilearen informazioa -->
            <div class="mt-4 pt-4 border-t border-gray-700 text-center text-xs text-gray-500">
                <p>Egilea: Beñat Erezuma Arisketa</p>
                <p><a href="https://berezuma.com" target="_blank" class="underline hover:text-gray-300">berezuma.com</a> • Lizentzia: MIT</p>
            </div>
        </div>

        <!-- 3D Simulazioaren edukiontzia -->
        <div id="canvas-container" class="flex-grow"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        const canvasContainer = document.getElementById('canvas-container');

        // --- OINARRIZKO KONFIGURAZIOA ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
        camera.position.z = 6; // Kamera hurbilago hasieran

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        // Itzalak gaitu
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        canvasContainer.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 2.5;
        controls.maxDistance = 50; // Zooma handitu

        // --- ARGIZTAPENA (LINTERNA EFEKTUAREKIN) ---
        const spotLight = new THREE.SpotLight(0xffffff, 500, 100, Math.PI / 8, 0.2, 2);
        spotLight.castShadow = true; // Argi honek itzalak sortuko ditu
        scene.add(spotLight);

        // Argiaren helburua (Lurraren zentroa)
        const spotLightTarget = new THREE.Object3D();
        spotLightTarget.position.set(0, 0, 0);
        scene.add(spotLightTarget);
        spotLight.target = spotLightTarget;

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.1); // Inguruneko argia, itzalak leuntzeko
        scene.add(ambientLight);

        // --- LURRAREN OBJEKTUAK ---
        const earthGroup = new THREE.Group();
        const EARTH_RADIUS = 1.5;
        const AXIAL_TILT = 23.44 * (Math.PI / 180);

        const earthGeometry = new THREE.SphereGeometry(EARTH_RADIUS, 64, 64);
        const earthMaterial = new THREE.MeshStandardMaterial({
            map: new THREE.TextureLoader().load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/land_ocean_ice_cloud_2048.jpg', 
                (texture) => { texture.colorSpace = THREE.SRGBColorSpace; },
                undefined,
                (err) => {
                    console.error('An error happened loading the texture.');
                    earthMaterial.map = null;
                    earthMaterial.color.set(0x2266dd);
                    earthMaterial.needsUpdate = true;
                }
            ),
            metalness: 0.2,
            roughness: 0.8
        });
        const earth = new THREE.Mesh(earthGeometry, earthMaterial);
        earth.castShadow = true; // Lurrak itzalak sortzen ditu
        earth.receiveShadow = true; // Lurrak beste objektuen itzalak jasotzen ditu
        
        earth.rotation.y = -Math.PI / 2;
        earthGroup.add(earth);

        const axisMaterial = new THREE.LineBasicMaterial({ color: 0xff0000, linewidth: 2 });
        const axisPoints = [new THREE.Vector3(0, -EARTH_RADIUS * 1.5, 0), new THREE.Vector3(0, EARTH_RADIUS * 1.5, 0)];
        const axisGeometry = new THREE.BufferGeometry().setFromPoints(axisPoints);
        const axisLine = new THREE.Line(axisGeometry, axisMaterial);
        earthGroup.add(axisLine);

        function createCircleLine(radius, color) {
            const points = [];
            for (let i = 0; i <= 128; i++) {
                const theta = (i / 128) * Math.PI * 2;
                points.push(new THREE.Vector3(Math.cos(theta) * radius, 0, Math.sin(theta) * radius));
            }
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ color: color });
            return new THREE.Line(geometry, material);
        }

        const equator = createCircleLine(EARTH_RADIUS, 0xffff00);
        earthGroup.add(equator);
        const tropicOfCancer = createCircleLine(EARTH_RADIUS * Math.cos(AXIAL_TILT), 0xffa500);
        tropicOfCancer.position.y = EARTH_RADIUS * Math.sin(AXIAL_TILT);
        earthGroup.add(tropicOfCancer);
        const tropicOfCapricorn = createCircleLine(EARTH_RADIUS * Math.cos(AXIAL_TILT), 0xffa500);
        tropicOfCapricorn.position.y = -EARTH_RADIUS * Math.sin(AXIAL_TILT);
        earthGroup.add(tropicOfCapricorn);

        const markerGeometry = new THREE.SphereGeometry(0.05, 16, 16);
        const markerMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const latitudeMarker = new THREE.Mesh(markerGeometry, markerMaterial);
        earthGroup.add(latitudeMarker);
        
        earthGroup.rotation.z = -AXIAL_TILT;
        scene.add(earthGroup);

        // --- KONTROLEN LOGIKA ---
        const daySlider = document.getElementById('day-slider');
        const latitudeSlider = document.getElementById('latitude-slider');
        const longitudeSlider = document.getElementById('longitude-slider');
        const dayDisplay = document.getElementById('day-display');
        const latitudeDisplay = document.getElementById('latitude-display');
        const longitudeDisplay = document.getElementById('longitude-display');
        const seasonDisplay = document.getElementById('season-display');
        const sunriseDisplay = document.getElementById('sunrise-display');
        const sunsetDisplay = document.getElementById('sunset-display');
        const durationDisplay = document.getElementById('duration-display');
        const polarStatusDisplay = document.getElementById('polar-status-display');
        const citySearchInput = document.getElementById('city-search');
        const searchButton = document.getElementById('search-button');
        const searchError = document.getElementById('search-error');
        const autocompleteResults = document.getElementById('autocomplete-results');
        const searchContainer = document.getElementById('search-container');
        const playButton = document.getElementById('play-button');
        const pauseButton = document.getElementById('pause-button');
        
        let isRotating = true; // Errotazioaren egoera

        function getDateFromDay(dayOfYear) {
            const date = new Date(new Date().getFullYear(), 0); 
            return new Date(date.setDate(dayOfYear));
        }

        function updateSimulation() {
            const dayOfYear = parseInt(daySlider.value);
            const latitude = parseFloat(latitudeSlider.value);
            const longitude = parseFloat(longitudeSlider.value);
            const date = getDateFromDay(dayOfYear);

            // 1. Argiaren posizioa eguneratu
            const sunDistance = 20;
            const sunAngle = (2 * Math.PI / 365) * (dayOfYear + 10);
            const sunDeclination = -AXIAL_TILT * Math.cos(sunAngle);
            
            const sunX = 0;
            const sunY = sunDistance * Math.sin(sunDeclination);
            const sunZ = sunDistance * Math.cos(sunDeclination);
            
            spotLight.position.set(sunX, sunY, sunZ);

            // 2. Markatzailea eguneratu
            const latRad = latitude * (Math.PI / 180);
            const lonRad = longitude * (Math.PI / 180);
            latitudeMarker.position.set(
                EARTH_RADIUS * Math.cos(latRad) * Math.sin(lonRad),
                EARTH_RADIUS * Math.sin(latRad),
                EARTH_RADIUS * Math.cos(latRad) * Math.cos(lonRad)
            );

            // 3. Interfazeko test

